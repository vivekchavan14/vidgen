"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.useMaxMediaDuration = void 0;
const media_parser_1 = require("@remotion/media-parser");
const media_utils_1 = require("@remotion/media-utils");
const react_1 = require("react");
const cache = new Map();
const getSrc = (s) => {
    if (s.type === 'video') {
        return s.src;
    }
    if (s.type === 'audio') {
        return s.src;
    }
    return null;
};
const useMaxMediaDuration = (s, fps) => {
    var _a;
    const src = getSrc(s);
    const [maxMediaDuration, setMaxMediaDuration] = (0, react_1.useState)(src ? ((_a = cache.get(src)) !== null && _a !== void 0 ? _a : null) : Infinity);
    (0, react_1.useEffect)(() => {
        if (!src) {
            return;
        }
        const controller = (0, media_parser_1.mediaParserController)();
        (0, media_parser_1.parseMedia)({
            src,
            controller,
            acknowledgeRemotionLicense: true,
            onDurationInSeconds: (duration) => {
                const durationOrInfinity = duration !== null && duration !== void 0 ? duration : Infinity;
                cache.set(src, Math.floor(durationOrInfinity * fps));
                setMaxMediaDuration(Math.floor(durationOrInfinity * fps));
            },
        }).catch((e) => {
            if ((0, media_parser_1.hasBeenAborted)(e)) {
                return;
            }
            // In case of CORS errors, fall back to getVideoMetadata
            (0, media_utils_1.getVideoMetadata)(src)
                .then((metadata) => {
                var _a;
                const durationOrInfinity = (_a = metadata.durationInSeconds) !== null && _a !== void 0 ? _a : Infinity;
                cache.set(src, Math.floor(durationOrInfinity * fps));
                setMaxMediaDuration(Math.floor(durationOrInfinity * fps));
            })
                .catch(() => { });
            throw e;
        });
        return () => {
            try {
                controller.abort();
            }
            catch (_a) { }
        };
    }, [src, fps]);
    return maxMediaDuration;
};
exports.useMaxMediaDuration = useMaxMediaDuration;
